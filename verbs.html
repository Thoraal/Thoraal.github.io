<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador Básico de XML SAT 4.0</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }
        .input-section {
            text-align: center;
            margin-bottom: 30px;
        }
        input[type="file"] {
            display: none;
        }
        .custom-file-upload {
            border: 2px dashed #007bff;
            display: inline-block;
            padding: 12px 25px;
            cursor: pointer;
            border-radius: 8px;
            color: #007bff;
            font-weight: bold;
            transition: all 0.3s ease;
            background-color: #eaf6ff;
        }
        .custom-file-upload:hover {
            background-color: #d1e7ff;
            color: #0056b3;
            border-color: #0056b3;
        }
        #fileName {
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }
        .results-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
        }
        .xml-raw, .extracted-data {
            flex: 1; /* Permite que cada sección ocupe el espacio disponible */
            min-width: 300px; /* Ancho mínimo para evitar que se vean muy apretados */
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        h2 {
            color: #34495e;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        pre {
            white-space: pre-wrap; /* Permite el ajuste de línea */
            word-wrap: break-word; /* Rompe palabras largas */
            max-height: 400px;
            overflow-y: auto;
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            color: #333;
            font-size: 0.9em;
        }
        .data-item {
            margin-bottom: 10px;
        }
        .data-item strong {
            color: #007bff;
        }
        #errorMessage {
            color: #dc3545;
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
        }
        .ms-3 { /* Simple margin-left para indentación de sub-items */
            margin-left: 1rem; /* 16px */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Procesador Básico de XML SAT 4.0</h1>
        <div class="input-section">
            <label for="xmlFile" class="custom-file-upload">
                Seleccionar archivo XML
            </label>
            <input type="file" id="xmlFile" accept=".xml">
            <div id="fileName">Ningún archivo seleccionado</div>
            <div id="errorMessage"></div>
        </div>

        <div class="results-section">
            <div class="xml-raw">
                <h2>Contenido XML (Raw)</h2>
                <pre id="xmlContent"></pre>
            </div>
            <div class="extracted-data">
                <h2>Datos Extraídos (Básico)</h2>
                <div id="extractedInfo">
                    <p>Carga un XML para ver los datos extraídos aquí.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const xmlFileInput = document.getElementById('xmlFile');
            const fileNameDisplay = document.getElementById('fileName');
            const xmlContentDisplay = document.getElementById('xmlContent');
            const extractedInfoDisplay = document.getElementById('extractedInfo');
            const errorMessageDisplay = document.getElementById('errorMessage');

            xmlFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = file.name;
                    errorMessageDisplay.textContent = ''; // Limpiar mensajes de error
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        const xmlString = e.target.result;
                        xmlContentDisplay.textContent = xmlString; // Mostrar el XML raw

                        try {
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(xmlString, "text/xml");

                            // Verificar si hubo errores de parseo
                            const parserError = xmlDoc.querySelector('parsererror');
                            if (parserError) {
                                throw new Error('Error al parsear el XML: ' + parserError.textContent);
                            }

                            extractData(xmlDoc);

                        } catch (error) {
                            errorMessageDisplay.textContent = `Error al procesar el XML: ${error.message}`;
                            extractedInfoDisplay.innerHTML = '<p>No se pudieron extraer datos debido a un error.</p>';
                        }
                    };

                    reader.onerror = () => {
                        errorMessageDisplay.textContent = 'Error al leer el archivo.';
                        fileNameDisplay.textContent = 'Ningún archivo seleccionado';
                        xmlContentDisplay.textContent = '';
                        extractedInfoDisplay.innerHTML = '<p>Error al leer el archivo.</p>';
                    };

                    reader.readAsText(file);
                } else {
                    fileNameDisplay.textContent = 'Ningún archivo seleccionado';
                    xmlContentDisplay.textContent = '';
                    extractedInfoDisplay.innerHTML = '<p>Carga un XML para ver los datos extraídos aquí.</p>';
                    errorMessageDisplay.textContent = '';
                }
            });

            function extractData(xmlDoc) {
                let htmlOutput = '';
                let hasData = false;

                // --- Comprobante (CFDI 4.0) ---
                // MODIFICADO: Seleccionamos el elemento "Comprobante" sin prefijo para mayor compatibilidad
                const comprobante = xmlDoc.querySelector('Comprobante'); // Ahora busca solo 'Comprobante'
                if (comprobante) {
                    // Verificamos la versión para asegurarnos de que sea 4.0 o intentarlo
                    const version = comprobante.getAttribute('Version');
                    if (version && version.startsWith('4.')) {
                        hasData = true;
                        htmlOutput += `<h3>Comprobante (CFDI ${version})</h3>`;
                        htmlOutput += `<div class="data-item"><strong>Versión:</strong> ${version || 'N/A'}</div>`;
                        htmlOutput += `<div class="data-item"><strong>Serie:</strong> ${comprobante.getAttribute('Serie') || 'N/A'}</div>`;
                        htmlOutput += `<div class="data-item"><strong>Folio:</strong> ${comprobante.getAttribute('Folio') || 'N/A'}</div>`;
                        htmlOutput += `<div class="data-item"><strong>Fecha:</strong> ${comprobante.getAttribute('Fecha') || 'N/A'}</div>`;
                        htmlOutput += `<div class="data-item"><strong>Subtotal:</strong> ${comprobante.getAttribute('SubTotal') || 'N/A'}</div>`;
                        htmlOutput += `<div class="data-item"><strong>Total:</strong> ${comprobante.getAttribute('Total') || 'N/A'}</div>`;
                        htmlOutput += `<div class="data-item"><strong>Moneda:</strong> ${comprobante.getAttribute('Moneda') || 'N/A'}</div>`;
                        htmlOutput += `<div class="data-item"><strong>Tipo de Comprobante:</strong> ${comprobante.getAttribute('TipoDeComprobante') || 'N/A'}</div>`;
                        htmlOutput += `<div class="data-item"><strong>Lugar de Expedición:</strong> ${comprobante.getAttribute('LugarExpedicion') || 'N/A'}</div>`;
                        htmlOutput += `<div class="data-item"><strong>Método de Pago:</strong> ${comprobante.getAttribute('MetodoPago') || 'N/A'}</div>`;
                        htmlOutput += `<div class="data-item"><strong>Forma de Pago:</strong> ${comprobante.getAttribute('FormaPago') || 'N/A'}</div>`;
                        htmlOutput += `<div class="data-item"><strong>Exportacion:</strong> ${comprobante.getAttribute('Exportacion') || 'N/A'}</div>`;

                        // --- Emisor ---
                        // MODIFICADO: Seleccionamos el elemento "Emisor" sin prefijo
                        const emisor = comprobante.querySelector('Emisor');
                        if (emisor) {
                            htmlOutput += '<h4>Emisor</h4>';
                            htmlOutput += `<div class="data-item"><strong>RFC:</strong> ${emisor.getAttribute('Rfc') || 'N/A'}</div>`;
                            htmlOutput += `<div class="data-item"><strong>Nombre:</strong> ${emisor.getAttribute('Nombre') || 'N/A'}</div>`;
                            htmlOutput += `<div class="data-item"><strong>Régimen Fiscal:</strong> ${emisor.getAttribute('RegimenFiscal') || 'N/A'}</div>`;
                        }

                        // --- Receptor ---
                        // MODIFICADO: Seleccionamos el elemento "Receptor" sin prefijo
                        const receptor = comprobante.querySelector('Receptor');
                        if (receptor) {
                            htmlOutput += '<h4>Receptor</h4>';
                            htmlOutput += `<div class="data-item"><strong>RFC:</strong> ${receptor.getAttribute('Rfc') || 'N/A'}</div>`;
                            htmlOutput += `<div class="data-item"><strong>Nombre:</strong> ${receptor.getAttribute('Nombre') || 'N/A'}</div>`;
                            htmlOutput += `<div class="data-item"><strong>Domicilio Fiscal Receptor:</strong> ${receptor.getAttribute('DomicilioFiscalReceptor') || 'N/A'}</div>`;
                            htmlOutput += `<div class="data-item"><strong>Régimen Fiscal Receptor:</strong> ${receptor.getAttribute('RegimenFiscalReceptor') || 'N/A'}</div>`;
                            htmlOutput += `<div class="data-item"><strong>Uso CFDI:</strong> ${receptor.getAttribute('UsoCFDI') || 'N/A'}</div>`;
                        }

                        // --- Conceptos ---
                        // MODIFICADO: Seleccionamos los elementos "Concepto" sin prefijo
                        const conceptos = comprobante.querySelectorAll('Conceptos Concepto');
                        if (conceptos.length > 0) {
                            htmlOutput += '<h4>Conceptos</h4>';
                            conceptos.forEach((concepto, index) => {
                                htmlOutput += `<div class="data-item"><strong>Concepto ${index + 1}:</strong></div>`;
                                htmlOutput += `<div class="data-item ms-3">Código Prod/Serv: ${concepto.getAttribute('ClaveProdServ') || 'N/A'}</div>`;
                                htmlOutput += `<div class="data-item ms-3">Cantidad: ${concepto.getAttribute('Cantidad') || 'N/A'}</div>`;
                                htmlOutput += `<div class="data-item ms-3">Unidad: ${concepto.getAttribute('ClaveUnidad') || 'N/A'}</div>`;
                                htmlOutput += `<div class="data-item ms-3">Descripción: ${concepto.getAttribute('Descripcion') || 'N/A'}</div>`;
                                htmlOutput += `<div class="data-item ms-3">Valor Unitario: ${concepto.getAttribute('ValorUnitario') || 'N/A'}</div>`;
                                htmlOutput += `<div class="data-item ms-3">Importe: ${concepto.getAttribute('Importe') || 'N/A'}</div>`;
                                htmlOutput += `<div class="data-item ms-3">ObjetoImp: ${concepto.getAttribute('ObjetoImp') || 'N/A'}</div>`;
                            });
                        }

                        // --- Impuestos (Traslados y Retenciones) ---
                        // MODIFICADO: Seleccionamos los elementos "Impuestos", "Traslados", "Traslado", "Retenciones", "Retencion" sin prefijo
                        const impuestos = comprobante.querySelector('Impuestos');
                        if (impuestos) {
                            htmlOutput += '<h4>Impuestos</h4>';
                            const totalImpuestosTrasladados = impuestos.getAttribute('TotalImpuestosTrasladados');
                            if (totalImpuestosTrasladados) {
                                htmlOutput += `<div class="data-item"><strong>Total Impuestos Trasladados:</strong> ${totalImpuestosTrasladados}</div>`;
                            }
                            const totalImpuestosRetenidos = impuestos.getAttribute('TotalImpuestosRetenidos');
                            if (totalImpuestosRetenidos) {
                                htmlOutput += `<div class="data-item"><strong>Total Impuestos Retenidos:</strong> ${totalImpuestosRetenidos}</div>`;
                            }

                            const traslados = impuestos.querySelectorAll('Traslados Traslado');
                            if (traslados.length > 0) {
                                htmlOutput += '<h5>Traslados</h5>';
                                traslados.forEach((traslado, index) => {
                                    htmlOutput += `<div class="data-item ms-3">Impuesto: ${traslado.getAttribute('Impuesto') || 'N/A'}</div>`;
                                    htmlOutput += `<div class="data-item ms-3">TipoFactor: ${traslado.getAttribute('TipoFactor') || 'N/A'}</div>`;
                                    htmlOutput += `<div class="data-item ms-3">TasaOCuota: ${traslado.getAttribute('TasaOCuota') || 'N/A'}</div>`;
                                    htmlOutput += `<div class="data-item ms-3">Importe: ${traslado.getAttribute('Importe') || 'N/A'}</div>`;
                                });
                            }

                            const retenciones = impuestos.querySelectorAll('Retenciones Retencion');
                            if (retenciones.length > 0) {
                                htmlOutput += '<h5>Retenciones</h5>';
                                retenciones.forEach((retencion, index) => {
                                    htmlOutput += `<div class="data-item ms-3">Impuesto: ${retencion.getAttribute('Impuesto') || 'N/A'}</div>`;
                                    htmlOutput += `<div class="data-item ms-3">Importe: ${retencion.getAttribute('Importe') || 'N/A'}</div>`;
                                });
                            }
                        }

                        // --- Complemento de Pago (si existe) ---
                        // Busca el elemento 'Complemento' y luego 'Pagos' y 'Pago' sin prefijos
                        const complemento = comprobante.querySelector('Complemento');
                        if (complemento) {
                            const pagoinf = complemento.querySelector('Pagos Pago'); // Asume que 'Pagos' y 'Pago' no tienen prefijo o se ignoran
                            if (pagoinf) {
                                htmlOutput += '<h3>Complemento de Pago (Información Básica)</h3>';
                                htmlOutput += `<div class="data-item"><strong>Fecha Pago:</strong> ${pagoinf.getAttribute('FechaPago') || 'N/A'}</div>`;
                                htmlOutput += `<div class="data-item"><strong>Monto Total Pagos:</strong> ${pagoinf.getAttribute('MontoTotalPagos') || 'N/A'}</div>`;
                                // Puedes añadir más detalles del complemento de pago aquí
                            }

                            // --- Complemento de Nomina (si existe) ---
                            const nomina = complemento.querySelector('Nomina'); // Asume que 'Nomina' no tiene prefijo o se ignora
                            if (nomina) {
                                htmlOutput += '<h3>Complemento de Nómina (Información Básica)</h3>';
                                htmlOutput += `<div class="data-item"><strong>Tipo de Nómina:</strong> ${nomina.getAttribute('TipoNomina') || 'N/A'}</div>`;
                                htmlOutput += `<div class="data-item"><strong>Fecha de Pago:</strong> ${nomina.getAttribute('FechaPago') || 'N/A'}</div>`;
                                // Puedes añadir más detalles de la nómina aquí
                            }
                        }

                    } else {
                        htmlOutput = '<p>La versión del Comprobante no es 4.x o no se pudo determinar. Este visor está diseñado para CFDI 4.0.</p>';
                    }
                } else {
                    htmlOutput = '<p>No se encontró el elemento principal `Comprobante` en el XML. Asegúrate de que el archivo sea un XML de CFDI válido.</p>';
                }

                extractedInfoDisplay.innerHTML = htmlOutput;
                if (!hasData) {
                    errorMessageDisplay.textContent = 'No se pudieron extraer datos importantes. El archivo podría no ser un CFDI 4.0 o estar mal formado.';
                } else {
                    errorMessageDisplay.textContent = ''; // Limpiar mensaje de error si se extrajo algo
                }
            }
        });
    </script>
</body>
</html>
