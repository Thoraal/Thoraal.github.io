<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraccionador de Números</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f7f9fc;
            padding: 0 20px;
            box-sizing: border-box;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
            max-width: 1000px;
        }
        h2 {
            color: #5900ff;
            font-weight: 700;
            margin-bottom: 20px;
        }
        .input-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .input-container input[type="number"],
        .input-container select,
        .input-container button {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            flex: 1 1 auto;
        }
        .input-container button {
            background-color: #5245ff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }
        .input-container button:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        th, td {
            border: 1px solid #ccc;
            padding: 12px;
            text-align: center;
            white-space: nowrap;
            font-size: 16px;
        }
        th {
            background-color: #007BFF;
            color: white;
            font-weight: 700;
        }
        td {
            padding: 15px;
        }
        tbody {
            display: block;
            max-height: 400px;
            overflow-y: auto;
        }
        thead, tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }
        tbody tr:nth-child(even) {
            background-color: #eef5ff;
        }
        tbody tr td:nth-child(3) {
            font-size: 18px;
        }
        .sum-result {
            margin-top: 20px;
            font-weight: bold;
            text-align: center;
            font-size: 18px;
            color: #333;
        }
        .labels-container {
            margin-top: 20px;
            text-align: left;
            font-size: 16px;
            color: #333;
            font-weight: bold;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 20px;
        }
        @media print {
            table {
                border: 1px solid black;
                border-collapse: collapse;
                width: 100%;
            }
            th, td {
                border: 1px solid black;
                padding: 10px;
                box-sizing: border-box;
            }
            th {
                background-color: #d3d3d3 !important;
                -webkit-print-color-adjust: exact;
            }
            tbody tr:nth-child(odd) {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact;
            }
            tbody tr:nth-child(even) {
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>Fraccionador de Números Mejorado</h2>
        <div class="input-container">
            <input type="number" id="numero" placeholder="Ingresa un número (Ej: 2500)" oninput="fraccionarNumero()" aria-label="Ingresar un número a fraccionar" />
            <select id="moneda" onchange="mostrarTipoCambio()">
                <option value="usd">Dólar americano</option>
                <option value="eur">Euro</option>
                <option value="cad">Canadiense</option>
                <option value="otro">Otro</option>
            </select>
            <input type="number" id="tipoCambio" class="tipo-cambio" placeholder="Tipo de cambio" oninput="fraccionarNumero()" />
            <button id="imprimirBtn" onclick="imprimirPDF()" disabled>Imprimir</button>
            <button onclick="borrarTodo()">Borrar Todo</button>
        </div>
        <div class="labels-container">
            <p>Monto: <span id="labelMonto"></span></p>
            <p>Tipo de cambio: <span id="labelTipoCambio"></span></p>
            <p>Total en moneda nacional: <span id="labelTotal"></span></p>
            <p class="error-message" id="verificacionMensaje"></p>
        </div>
        <table id="resultado">
            <thead>
                <tr>
                    <th># Op</th>
                    <th>Cantidad</th>
                    <th></th>
                    <th>Monto (MXN)</th>
                    <th>Restante</th>
                    <th>Total (MXN)</th>
                    <th>Desglosado</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="sumaResultado" class="sum-result"></div>
    </div>

    <script>
        function fraccionarNumero() {
            if (document.getElementById("numero").value === "" || document.getElementById("tipoCambio").value === "") {
                document.getElementById("verificacionMensaje").textContent = "Error: Todos los campos deben estar llenos.";
                document.getElementById("imprimirBtn").disabled = true;
                limpiarResultado();
                return;
            }
            const numero = parseInt(document.getElementById("numero").value);
            const tipoCambio = parseFloat(document.getElementById("tipoCambio").value) || 1;

            if (!validarNumero(numero)) {
                limpiarResultado();
                return;
            }

            const totalMonedaNacional = (numero * tipoCambio).toFixed(2);
            document.getElementById("labelMonto").textContent = `$${numberWithCommas(numero)}`;
            document.getElementById("labelTipoCambio").textContent = `${tipoCambio}`;
            document.getElementById("labelTotal").textContent = `$${numberWithCommas(totalMonedaNacional)}`;

            const seed = numero;
            const randomGenerator = mulberry32(seed);
            let partes = [];
            let restante = numero;
            const min = 400;
            const max = 990;
            const maxPartes = 45;
            let intentos = 0;
            const maxIntentos = 10;
            let suma;

            do {
                partes = [];
                restante = numero;

                while (restante > 0 && partes.length < maxPartes) {
                    let fraccion = Math.floor(randomGenerator() * (max - min + 1)) + min;
                    fraccion = Math.round(fraccion / 5) * 5;
                    fraccion = Math.min(fraccion, restante);
                    partes.push(fraccion);
                    restante -= fraccion;
                }

                suma = partes.reduce((acc, val) => acc + val, 0);
                intentos++;
            } while (suma !== numero && intentos < maxIntentos);

            if (suma !== numero) {
                document.getElementById("verificacionMensaje").textContent = `Error: No se pudo generar una combinación correcta después de ${maxIntentos} intentos. Por favor, intente nuevamente.`;
                document.getElementById("imprimirBtn").disabled = true;
                limpiarResultado();
            } else {
                document.getElementById("sumaResultado").textContent = `$${numberWithCommas(partes.reduce((acc, val) => acc + val, 0))} verificación correcta`;
                
                document.getElementById("imprimirBtn").disabled = false;
                mostrarResultado(partes, numero);
            }
        }

        function validarNumero(numero) {
            return !isNaN(numero) && numero > 0 && Number.isInteger(numero);
        }

        function mostrarResultado(partes, numeroInicial) {
            const tipoCambio = parseFloat(document.getElementById("tipoCambio").value) || 1;
            const resultado = document.getElementById("resultado").getElementsByTagName("tbody")[0];

            let resultadoHTML = '';
            let restante = numeroInicial;
            let totalMXN = 0;
            let desglosado = 0;
            partes.forEach((parte, index) => {
                restante -= parte;
                const montoMXN = (parte * tipoCambio).toFixed(2);
                totalMXN += parseFloat(montoMXN);
                desglosado += parte;
                resultadoHTML += `
                    <tr>
                        <td>${(index + 1).toString().padStart(2, '0')}</td>
                        <td>${parte}</td>
                        <td>[    ]</td>
                        <td>$${numberWithCommas(montoMXN)}</td>
                        <td>$${numberWithCommas((restante > 0 ? restante : 0).toFixed(2))}</td>
                        <td>$${numberWithCommas(totalMXN.toFixed(2))}</td>
                        <td>$${numberWithCommas(desglosado.toFixed(2))}</td>
                    </tr>`;
            });
            resultado.innerHTML = resultadoHTML;
        }

        function imprimirPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'letter' });

            const numero = parseInt(document.getElementById("numero").value);
            const tipoCambio = parseFloat(document.getElementById("tipoCambio").value) || 1;
            const moneda = document.getElementById("moneda").options[document.getElementById("moneda").selectedIndex].text;
            const totalMonedaNacional = (numero * tipoCambio).toFixed(2);

            doc.setFontSize(14);
            doc.text(`Fecha y hora: ${new Date().toLocaleString()}  |  ${moneda} - $${numberWithCommas(numero)} * ${tipoCambio} = $${numberWithCommas(totalMonedaNacional)}`, 40, 60);

            const xCol1 = 40;
            const xCol2 = 80;
            const xCol3 = 120;
            const xCol4 = 150;
            const xCol5 = 240;
            const xCol6 = 320;
            const xCol7 = 400;

            let y = 100;

            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("#Op", xCol1, y);
            doc.text("Cantidad", xCol2, y);
            doc.text("", xCol3, y);
            doc.text("Monto (MXN)", xCol4, y);
            doc.text("Restante", xCol5, y);
            doc.text("Total (MXN)", xCol6, y);
            doc.text("Desglosado", xCol7, y);
            y += 20;

            doc.setFont(undefined, 'normal');
            const tabla = document.getElementById("resultado");

            for (let i = 1, row; row = tabla.rows[i]; i++) {
                const celdas = Array.from(row.cells);

                doc.text(celdas[0].textContent, xCol1, y);
                doc.text(celdas[1].textContent, xCol2, y);
                doc.text(celdas[2].textContent === "☐" ? "[]" : celdas[2].textContent, xCol3, y);
                doc.text(celdas[3].textContent, xCol4, y);
                doc.text(celdas[4].textContent, xCol5, y);
                doc.text(celdas[5].textContent, xCol6, y);
                doc.text(celdas[6].textContent, xCol7, y);

                y += 15;
            }

            doc.text(document.getElementById("sumaResultado").textContent, xCol1, y + 10);

            doc.autoPrint();
            window.open(doc.output('bloburl'), '_blank');
        }

        function mostrarTipoCambio() {
            const tipoCambioInput = document.getElementById("tipoCambio");
            tipoCambioInput.style.display = "block";
            fraccionarNumero();
        }

        function borrarTodo() {
            document.getElementById("numero").value = "";
            document.getElementById("tipoCambio").value = "";
            limpiarResultado();
        }

        function limpiarResultado() {
            document.getElementById("sumaResultado").textContent = "";
            document.getElementById("resultado").getElementsByTagName("tbody")[0].innerHTML = "";
            document.getElementById("labelMonto").textContent = "";
            document.getElementById("labelTipoCambio").textContent = "";
            document.getElementById("labelTotal").textContent = "";
            document.getElementById("verificacionMensaje").textContent = "";
            document.getElementById("imprimirBtn").disabled = true;
        }

        function mulberry32(seed) {
            return function() {
                let t = seed += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    </script>
</body>
</html>